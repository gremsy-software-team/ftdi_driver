cmake_minimum_required(VERSION 3.5)

project(ftdi_sio C)

include (ExternalProject)

ExternalProject_Add(${PROJECT_NAME}
	SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}"
	DOWNLOAD_COMMAND cp -dpRf ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_BINARY_DIR}/
	CONFIGURE_COMMAND ""
	BUILD_COMMAND $(MAKE) -C ${CMAKE_CURRENT_BINARY_DIR}/ftdi_sio_v4 CROSS_COMPILE=${TOOLCHAIN_DIR}/usr/bin/${TOOLCHAIN_NAME}/${TOOLCHAIN_NAME}- ARCH=${KERNEL_ARCH} KERNEL_HEADERS_DIR=${KERNELHEADERS_DIR}
        INSTALL_COMMAND ""
	DEPENDS ${MODULE_DEPENDS}
)

ExternalProject_Add_Step(${PROJECT_NAME} add_module_to_fakeroot
    COMMAND ${CMAKE_COMMAND} -E make_directory ${FAKEROOT_DIR}/lib/modules/${KERNEL_VERSION}/extra/
    COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_CURRENT_BINARY_DIR}/ftdi_sio_v4/${PROJECT_NAME}.ko ${FAKEROOT_DIR}/lib/modules/${KERNEL_VERSION}/extra/
    ALWAYS TRUE
    DEPENDEES install)
